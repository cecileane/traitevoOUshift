---
title: "contrast variance by randomroot and fixedroot"
author: "Cecile Ane and Qing Yu(Sabrina)"
date: "Octobor 2nd, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Focus of the report

In this report, our goal is to find out the reason that the covariance matrices generated by two root models are the same. Another problem is that variance of the contrast is not as expected, which I will explain later in the report. I checked the formula given in the `phylolm` package for `transf_branch_length` function and found out the fomulas were correctly used and generated the same result as expected. Under "OUrandomRoot", t is transformed
to $exp(-2*alpha*(T - t))$, where T is now the mean root-to-tip distance. Under "OUfixedRroot", t is
transformed to $exp(-2*alpha*(T - t))(1 - exp(-2*alpha*t))$ (as shown from the last session). So, the potential issue we need to deal with is that the covariance matrix we get from `sqrt_OU_covariance` function is not divided by $2*alpha$. Mohammad and I are still working on fixing the bug. 

#1. Potential bug regarding to the same covariance matrix of the tree generated by two models

```{r, include=FALSE}
library('phylolm')
library('l1ou')
data(lizard.tree)
```

```{r}
#truealpha=0.695680760276337
#sigma2=0.0704145586093487
truealpha=0.6957
```

covariance matrix generated by OUfixedRoot model
```{r}
REfr = sqrt_OU_covariance(lizard.tree, alpha=truealpha, 
                        root.model = "OUfixedRoot",normalize.tree.hight=T ,
                        check.order=F, check.ultrametric=F)

C.IHfr  = t(REfr$sqrtInvSigma)
C.Hfr   = REfr$sqrtSigma
```
`C.IHfr' represents the transpose of square root of  the inverse matrix of covariance generated by OUfixedRoot model
'C.Hfr' represents the square root of the covariance matrix generated by OUfixedRoot model.


covariance matrix generated by OUrandomRoot model
```{r}
RErr = sqrt_OU_covariance(lizard.tree, alpha=truealpha, 
                          root.model = "OUrandomRoot", normalize.tree.hight=T,
                          check.order=F, check.ultrametric=F)
C.IHrr  = t(RErr$sqrtInvSigma)
C.Hrr   = RErr$sqrtSigma
```
`C.IHrr' represents the transpose of square root of  the inverse matrix of covariance generated by OUrandomRoot model
'C.Hrr' represents the square root of the covariance matrix generated by OUrandomRoot model.
```{r}
all.equal(C.Hrr[,1:99],C.Hfr[,1:99])
```

It turns out covariance matrics of trees generated using two models are different except for the covariance with the root edge.That is why we exclude the last column for covariance matrix for comparison. The reason we get rid of the last column of the covariance matrix is that we know for the root, its covariance with other edges should be the same regardless of the root model they used to generate the matrix. However, we do expect the first 99 non-root edges have different covariance matrix for OUrandomRoot model and OUfixedRoot model.


#2. Potential bug on variance of the contrast which should be sigma2.

`tij` represents the time spent from the root to the node.
`dij` represents two times the time spent from the node to the tip.
The height of the tree is the maximum number of `tij`
We expect to see `C.IH%*%vrandom%*%t(C.IH)` to be an identity matrix. Unfortunately,
it is not as we can see the result above. 
Since this matrix is big, we just take a look at the diagonal of this matrix and to see if other number off the diagonal is 0. 

$\gamma=\sigma^2/(2\alpha)$ is the stationary variance:
the variance of the OU process $(Y_t)_t$ when $t$ goes to $\infty$.
After a fixed time of evolution $T$, 
$\gamma (1-e^{-2 \alpha T})$ is the variance of $Y_t$ if the root value $Y_0$ is fixed
with variance 0. The covariance matrix (`Vij`) should be equal to $\ (1/2 * \alpha e^{- dij})$. Since `C.IH` is 
equal to $V^{-1/2}$ and `C.IH%*%t(C.IH)` should be  $V^{-1}$, so  `C.IH%*%Vij%*%t(C.IH)` 
should be the identity matrix. 

`vrandom` is the covariance matrix generated by OUrandomRoot model.
```{r}
options(digits=4)
tij=vcv(lizard.tree)  # the time spent on each edge
treeheight=max(tij)   
dij=2*(treeheight-tij)  
vrandom=1/(2*truealpha)*exp(-truealpha*dij) # Sigma generated by OUrandomRoot model
Ind_random=C.IHrr%*%vrandom%*%t(C.IHrr)
diag(Ind_random)
# Now, the diagonal of the matrix is 1.
diag(Ind_random*(2*truealpha))
# Check if the number off the diagonal is 0.
Ind_rep=Ind_random
diag(Ind_rep)=NA
max(abs(Ind_rep),na.rm =T)

```

However, the numbers on the diagonal is not 1. They become 1 when I multiply them by `(2*truealpha)`. The numbers which are not on the diagonal are all zeros. 

`vfix` is the covariance matrix generated by OUfixedRoot model.
```{r}
vfix=1/(2*truealpha)*exp(-truealpha*dij)*(1-exp(-2*truealpha*tij))
Ind_fix=C.IHfr%*%vfix%*%t(C.IHfr)
diag(Ind_fix)
# Now, the diagonal of the matrix is 1.
diag(Ind_fix*(2*truealpha)/(1-exp(-2*truealpha*treeheight)))
# Check if the number off the diagonal is 0.
Ind_rep=Ind_fix
diag(Ind_rep)=NA
max(abs(Ind_rep),na.rm =T)
```

However, the numbers on the diagonal is not 1. They become 1 when I multiply them by `(2*truealpha)/(1-exp(-2*truealpha*treeheight))`. The numbers which are not on the diagonal are all zeros. 




