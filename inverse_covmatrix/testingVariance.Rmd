---
title: "contrast variance by randomroot and fixedroot_Bugfixed"
author: "Cecile Ane and Qing Yu(Sabrina)"
date: "Nov 17th, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Focus of the report

In this report, we use `Rstudio` with version `r getRversion()` and `l1ou` package with version `r packageVersion("l1ou")`.  our goal is to find out the reason that the covariance matrices generated by two root models are the same. Another problem is that variance of the contrast is not as expected, which I will explain later in the report. I checked the formula given in the `phylolm` package for `transf_branch_length` function and found out the fomulas were correctly used and generated the same result as expected. The tree should be ultrametric. t is the time from root to node. Under "OUrandomRoot", t is transformed to $\exp(-2*\alpha*(T - t))$, where T is now the mean root-to-tip distance. Under "OUfixedRroot", t is transformed to $\exp(-2*\alpha*(T - t))(1 - exp(-2*\alpha*t))$ (as shown from the last session). So, the potential issue we need to deal with is that the covariance matrix we get from `sqrt_OU_covariance` function is not divided by $2*\alpha$. Mohammad and I are still working on fixing the bug. 

#1. Potential bug regarding to the same covariance matrix of the tree generated by two models

```{r, include=FALSE}
library('phylolm')
library('l1ou')
data(lizard.tree)
```

```{r}
#truealpha=0.695680760276337
#sigma2=0.0704145586093487
truealpha=0.6957
```

Let us look at the covariance matrix generated by two root models.
`tij` represents the time spent from the root to the node.
`dij` represents two times the time spent from the node to the tip.
The height of the tree is the maximum number of `tij`.
`vrandom` represents the covariance matrix generated by OUrandomRoot model.
`vfix` represents the covariance matrix generated by OUfixedRoot model.
```{r}
options(digits=4)
tij=vcv(lizard.tree)  # the time spent on each edge
treeheight=max(tij)   
dij=2*(treeheight-tij) 
vrandom=1/(2*truealpha)*exp(-truealpha*dij) # Sigma generated by OUrandomRoot model
vfix=1/(2*truealpha)*exp(-truealpha*dij)*(1-exp(-2*truealpha*tij))
```

Then, we can also get transpose of square root of  the inverse matrix of covariance and the square root of the covariance matrix .
`Dtf' represents the transpose of square root of  the inverse matrix of covariance generated by OUfixedRoot model.
'Bf' represents the square root of the covariance matrix generated by OUfixedRoot model.
```{r}
REf = sqrt_OU_covariance(lizard.tree, alpha=truealpha, 
                        root.model = "OUfixedRoot",normalize.tree.height=T ,
                        check.order=F, check.ultrametric=F)

Dtf  = t(REf$sqrtInvSigma)
Bf   = REf$sqrtSigma
diag(Dtf%*%Bf)
```

`Dtr' represents the transpose of square root of the inverse matrix of covariance generated by OUrandomRoot model.
'Br' represents the square root of the covariance matrix generated by OUrandomRoot model.
```{r}
REr = sqrt_OU_covariance(lizard.tree, alpha=truealpha, 
                          root.model = "OUrandomRoot", normalize.tree.height=T,
                          check.order=F, check.ultrametric=F)
Dtr  = t(REr$sqrtInvSigma)
Br   = REr$sqrtSigma
diag(Dtr%*%Br)
```

In the last version of `l1ou` (1.27), there were a bug due to the function `normalized_tree`. For the tree has a root edge, the root edge was not used in the funtion. In addition, the distance from the root to all tips did not include the length of the root.edge. Due to this bug, the square root of the covariance matrix generated by the two models are the same except for the last column which is the covariance of the root with other edges. Now, the bug has been fixed and the square root of the covariance matrix generated by the two models are different. 
```{r}
all.equal(Bf[,1:99],Br[,1:99])
```


#2. Potential bug on variance of the contrast which should be sigma2.

We expect to see $D{\Sigma}{D^T}={I_{n}}$.Since `D` is equal to $V^{-1/2}$ and $D{D^T}$ should be  $V^{-1}$, so  $D{\Sigma}{D^T}={I_{n}}$. 

Since this matrix is big, we just take a look at the diagonal of this matrix and to see if other number off the diagonal is 0. 

Now, lets take a look at the $D{\Sigma}{D^T}$ generated by OUrandomRoot Model.
```{r}
Ind_random=Dtr%*%vrandom%*%t(Dtr)
diag(Ind_random)
1/(2*truealpha)
# # Now, the diagonal of the matrix is 1.
# diag(Ind_random*(2*truealpha))
```
$\gamma=\sigma^2/(2\alpha)$ is the stationary variance:
the variance of the OU process $(Y_t)_t$ when $t$ goes to $\infty$.In this case, the diagonal of the $D{\Sigma}{D^T}$ is equal to $1/(2\alpha)$, which is suppose to be 1. They become 1 when I multiply them by $(2\alpha)$. 

### Check if the number off the diagonal is 0.
```{r}
Ind_rep=Ind_random
diag(Ind_rep)=NA
max(abs(Ind_rep),na.rm =T)
```
The numbers which are not on the diagonal are all zeros. 

Furthermore, $B{B^T}$ should be equal to ${\Sigma}$ and$B={{D^{-1}}^T}$ .However, they are different.
```{r}
options(digits = 4)
vrandom_sup=Br%*%t(Br)
dimnames(vrandom_sup)=dimnames(vrandom)
all.equal(vrandom,vrandom_sup)
all.equal(t(solve(t(Dtr))),Br)
# all.equal(vrandom_sup,vrandom*(2*truealpha))
```



Now, let us take a look at the $D{\Sigma}{D^T}$ generated by OUfixeDtroot Model.
```{r}
Ind_fix=Dtf%*%vfix%*%t(Dtf)
diag(Ind_fix)
(1-exp(-2*truealpha*treeheight))/(2*truealpha)
# # Now, the diagonal of the matrix is 1.
# diag(Ind_fix*(2*truealpha)/(1-exp(-2*truealpha*treeheight)))
```
In this case, the diagonal of the $D{\Sigma}{D^T}$ is equal to $(1-\exp(-2*\alpha*T))/(2*\alpha)$, which is suppose to be 1.


### Check if the number off the diagonal is 0.
```{r}
Ind_rep=Ind_fix
diag(Ind_rep)=NA
max(abs(Ind_rep),na.rm =T)
```
The numbers which are not on the diagonal are all zeros. 

Furthermore, $B{B^T}$ should be equal to ${\Sigma}$ and $B={{D^{-1}}^T}$. However, they are different.
```{r}
vfix_sup=Bf%*%t(Bf)
dimnames(vfix_sup)=dimnames(vfix)
all.equal(vfix,vfix_sup)
all.equal(t(solve(t(Dtf))),Bf)

```


We can see for covariance matrix generated by both model, their values do not match with $D{D^T}$ and $B{B^T}$. So, there may be bug inside `sqrt_OU_covariance` for generating `D` and `B`. 

